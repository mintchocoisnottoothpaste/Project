libname raw "/userdata20/rroom029/data_source/user_data";/*raw data*/
libname db "/userdata20/rroom029/data_out/data_store"; 
libname db_out "/userdata20/rroom029/data_out/data_out";
libname RES "/userdata20/rroom029/data_out/data_out/RES";

/*COX AND KM ESTIMATES*/


/*Table 4. Cox Model*/

/*데이터셋 사이즈 줄이기*/
%MACRO PHREG_UNI(VAR, VARREF);
DATA TG_DEMO_&VAR.(KEEP=&VAR. SURVTIME&YR. DEATH&YR.) ; SET DB.TG_DEMO;  &COND.; RUN;
PROC PHREG DATA=TG_DEMO_&VAR. ; CLASS &VAR. (REF=&VARREF.); MODEL SURVTIME&YR.*DEATH&YR.(0)=&VAR. /RL; RUN;
%MEND;


/*FULL SURVIVAL COX*/
%LET YR=;

/*2 YEAR SURVIVAL COX*/
%LET YR=_2YR;


/*Table 4a. Cox model for all patients (n=192,801)*/
%LET COND=;
%PHREG_UNI(SEX_TYPE,'2');
%PHREG_UNI(C_AGE_GRP2,'01. 65-74');
%PHREG_UNI(INC_QUINTILE,'5');
%PHREG_UNI(SIDO_CD,'11');
%PHREG_UNI(RESID_GRP,'01.METRO');
%PHREG_UNI(CCI_GRP,'01. 0-2');
%PHREG_UNI(C_YEAR_GRP1,'01. 2009-2011');
%PHREG_UNI(LTC_MAIN_USE,'04. 이용안함');
%PHREG_UNI(TRT_YN,'0');
%PHREG_UNI(OP_YN,'0');
%PHREG_UNI(CT_YN,'0');
%PHREG_UNI(RT_YN,'0');
%PHREG_UNI(OP_CTG,'05. None');
%PHREG_UNI(CT_CYT_YN,'0');
%PHREG_UNI(CT_TAR_YN,'0');
%PHREG_UNI(CT_IMU_YN,'0');
%PHREG_UNI(CT_OTH_YN,'0');

/*다변량 : 모형 1*/ /*MULTIVARIATE에는 SIDO_CD만 넣음*/
DATA TG_DEMO_MUL1 (KEEP=SEX_TYPE C_AGE_GRP2 INC_QUINTILE SIDO_CD CCI_GRP C_YEAR_GRP1 LTC_MAIN_USE OP_YN CT_YN RT_YN SURVTIME&YR. DEATH&YR.) ; SET DB.TG_DEMO; &COND.; RUN;
PROC PHREG DATA=TG_DEMO_MUL1;
CLASS SEX_TYPE (REF='2') C_AGE_GRP2 (REF='01. 65-74') INC_QUINTILE(REF='5') SIDO_CD(REF='11') CCI_GRP(REF='01. 0-2') 
C_YEAR_GRP1(REF="01. 2009-2011") LTC_MAIN_USE (REF='04. 이용안함') OP_YN(REF='0') CT_YN(REF='0') RT_YN(REF='0') ;
MODEL SURVTIME&YR.*DEATH&YR.(0)=SEX_TYPE C_AGE_GRP2 INC_QUINTILE SIDO_CD CCI_GRP C_YEAR_GRP1 LTC_MAIN_USE OP_YN CT_YN RT_YN
/RL; RUN;

/*다변량 : 모형 2*/
DATA TG_DEMO_MUL2 (KEEP=SEX_TYPE C_AGE_GRP2 INC_QUINTILE SIDO_CD CCI_GRP C_YEAR_GRP1 LTC_MAIN_USE OP_CTG CT_CYT_YN CT_TAR_YN CT_IMU_YN CT_OTH_YN RT_YN SURVTIME&YR. DEATH&YR.) ; SET DB.TG_DEMO; &COND.; RUN;
PROC PHREG DATA=TG_DEMO_MUL2;
CLASS SEX_TYPE (REF='2') C_AGE_GRP2 (REF='01. 65-74') INC_QUINTILE(REF='5') SIDO_CD(REF='11') CCI_GRP(REF='01. 0-2') 
C_YEAR_GRP1(REF="01. 2009-2011") LTC_MAIN_USE (REF='04. 이용안함') OP_CTG(REF='05. None') CT_CYT_YN(REF='0') CT_TAR_YN(REF='0') CT_IMU_YN(REF='0') CT_OTH_YN(REF='0')  RT_YN(REF='0') ;
MODEL SURVTIME&YR.*DEATH&YR.(0)=SEX_TYPE C_AGE_GRP2 INC_QUINTILE SIDO_CD CCI_GRP C_YEAR_GRP1 LTC_MAIN_USE OP_CTG CT_CYT_YN CT_TAR_YN CT_IMU_YN CT_OTH_YN RT_YN
/RL;  RUN;

/*다변량 : 모형 3*/
DATA TG_DEMO_MUL3 (KEEP=SEX_TYPE C_AGE_GRP2 INC_QUINTILE SIDO_CD CCI_GRP C_YEAR_GRP1 LTC_MAIN_USE OP_CTG CT_YN RT_YN SURVTIME&YR. DEATH&YR.) ; SET DB.TG_DEMO; &COND.; RUN;
PROC PHREG DATA=TG_DEMO_MUL3;
CLASS SEX_TYPE (REF='2') C_AGE_GRP2 (REF='01. 65-74') INC_QUINTILE(REF='5') SIDO_CD(REF='11') CCI_GRP(REF='01. 0-2') 
C_YEAR_GRP1(REF="01. 2009-2011") LTC_MAIN_USE (REF='04. 이용안함')  OP_CTG(REF='05. None')  CT_YN(REF='0') RT_YN(REF='0') ;
MODEL SURVTIME&YR.*DEATH&YR.(0)=SEX_TYPE C_AGE_GRP2 INC_QUINTILE SIDO_CD CCI_GRP C_YEAR_GRP1 LTC_MAIN_USE  OP_CTG CT_YN RT_YN
/RL;  RUN;

/*다변량 : 모형 4*/
DATA TG_DEMO_MUL4 (KEEP=SEX_TYPE C_AGE_GRP2 INC_QUINTILE SIDO_CD CCI_GRP C_YEAR_GRP1 LTC_MAIN_USE TRT_YN SURVTIME&YR. DEATH&YR.) ; SET DB.TG_DEMO; &COND.; RUN;
PROC PHREG DATA=TG_DEMO_MUL4 ;
CLASS SEX_TYPE (REF='2') C_AGE_GRP2 (REF='01. 65-74') INC_QUINTILE(REF='5') SIDO_CD(REF='11') CCI_GRP(REF='01. 0-2') 
C_YEAR_GRP1(REF="01. 2009-2011") LTC_MAIN_USE (REF='04. 이용안함') TRT_YN(REF='0')  ;
MODEL SURVTIME&YR.*DEATH&YR.(0)=SEX_TYPE C_AGE_GRP2 INC_QUINTILE SIDO_CD CCI_GRP C_YEAR_GRP1 LTC_MAIN_USE  TRT_YN
/RL;  RUN;




/*Table 4b. Cox model for treatment group (n=107,426)*/
%LET COND= WHERE TRT_YN=1;
/*단변량*/
%PHREG_UNI(SEX_TYPE,'2');
%PHREG_UNI(C_AGE_GRP2,'01. 65-74');
%PHREG_UNI(INC_QUINTILE,'5');
%PHREG_UNI(SIDO_CD,'11');
%PHREG_UNI(RESID_GRP,'01.METRO');
%PHREG_UNI(CCI_GRP,'01. 0-2');
%PHREG_UNI(C_YEAR_GRP1,'01. 2009-2011');
%PHREG_UNI(LTC_MAIN_USE,'04. 이용안함');
/*%PHREG_UNI(TRT_YN,'0');*/
%PHREG_UNI(OP_YN,'0');
%PHREG_UNI(CT_YN,'0');
%PHREG_UNI(RT_YN,'0');
%PHREG_UNI(OP_CTG,'05. None');
%PHREG_UNI(CT_CYT_YN,'0');
%PHREG_UNI(CT_TAR_YN,'0');
%PHREG_UNI(CT_IMU_YN,'0');
%PHREG_UNI(CT_OTH_YN,'0');


/*다변량*/ 
/*다변량 : 모형 1*/ /*MULTIVARIATE에는 SIDO_CD만 넣음*/
DATA TG_DEMO_MUL1 (KEEP=SEX_TYPE C_AGE_GRP2 INC_QUINTILE SIDO_CD CCI_GRP C_YEAR_GRP1 LTC_MAIN_USE OP_YN CT_YN RT_YN SURVTIME&YR. DEATH&YR.) ; SET DB.TG_DEMO; &COND.; RUN;
PROC PHREG DATA=TG_DEMO_MUL1;
CLASS SEX_TYPE (REF='2') C_AGE_GRP2 (REF='01. 65-74') INC_QUINTILE(REF='5') SIDO_CD(REF='11') CCI_GRP(REF='01. 0-2') 
C_YEAR_GRP1(REF="01. 2009-2011") LTC_MAIN_USE (REF='04. 이용안함') OP_YN(REF='0') CT_YN(REF='0') RT_YN(REF='0') ;
MODEL SURVTIME&YR.*DEATH&YR.(0)=SEX_TYPE C_AGE_GRP2 INC_QUINTILE SIDO_CD CCI_GRP C_YEAR_GRP1 LTC_MAIN_USE OP_YN CT_YN RT_YN
/RL; RUN;

/*다변량 : 모형 2*/
DATA TG_DEMO_MUL2 (KEEP=SEX_TYPE C_AGE_GRP2 INC_QUINTILE SIDO_CD CCI_GRP C_YEAR_GRP1 LTC_MAIN_USE OP_CTG CT_CYT_YN CT_TAR_YN CT_IMU_YN CT_OTH_YN RT_YN SURVTIME&YR. DEATH&YR.) ; SET DB.TG_DEMO; &COND.; RUN;
PROC PHREG DATA=TG_DEMO_MUL2;
CLASS SEX_TYPE (REF='2') C_AGE_GRP2 (REF='01. 65-74') INC_QUINTILE(REF='5') SIDO_CD(REF='11') CCI_GRP(REF='01. 0-2') 
C_YEAR_GRP1(REF="01. 2009-2011") LTC_MAIN_USE (REF='04. 이용안함') OP_CTG(REF='05. None') CT_CYT_YN(REF='0') CT_TAR_YN(REF='0') CT_IMU_YN(REF='0') CT_OTH_YN(REF='0')  RT_YN(REF='0') ;
MODEL SURVTIME&YR.*DEATH&YR.(0)=SEX_TYPE C_AGE_GRP2 INC_QUINTILE SIDO_CD CCI_GRP C_YEAR_GRP1 LTC_MAIN_USE OP_CTG CT_CYT_YN CT_TAR_YN CT_IMU_YN CT_OTH_YN RT_YN
/RL; RUN;

/*다변량 : 모형 3*/
DATA TG_DEMO_MUL3 (KEEP=SEX_TYPE C_AGE_GRP2 INC_QUINTILE SIDO_CD CCI_GRP C_YEAR_GRP1 LTC_MAIN_USE OP_CTG CT_YN RT_YN SURVTIME&YR. DEATH&YR.) ; SET DB.TG_DEMO; &COND.; RUN;
PROC PHREG DATA=TG_DEMO_MUL3;
CLASS SEX_TYPE (REF='2') C_AGE_GRP2 (REF='01. 65-74') INC_QUINTILE(REF='5') SIDO_CD(REF='11') CCI_GRP(REF='01. 0-2') 
C_YEAR_GRP1(REF="01. 2009-2011") LTC_MAIN_USE (REF='04. 이용안함')  OP_CTG(REF='05. None')  CT_YN(REF='0') RT_YN(REF='0') ;
MODEL SURVTIME&YR.*DEATH&YR.(0)=SEX_TYPE C_AGE_GRP2 INC_QUINTILE SIDO_CD CCI_GRP C_YEAR_GRP1 LTC_MAIN_USE  OP_CTG CT_YN RT_YN
/RL;  RUN;




/*Table 4c. Cox model for no treatment group (n=85,375)*/
%LET COND= WHERE TRT_YN=0;
/*단변량*/
%PHREG_UNI(SEX_TYPE,'2');
%PHREG_UNI(C_AGE_GRP2,'01. 65-74');
%PHREG_UNI(INC_QUINTILE,'5');
%PHREG_UNI(SIDO_CD,'11');
%PHREG_UNI(RESID_GRP,'01.METRO');
%PHREG_UNI(CCI_GRP,'01. 0-2');
%PHREG_UNI(C_YEAR_GRP1,'01. 2009-2011');
%PHREG_UNI(LTC_MAIN_USE,'04. 이용안함');


/*다변량*/ 
DATA TG_DEMO_MUL (KEEP=SEX_TYPE C_AGE_GRP2 INC_QUINTILE SIDO_CD CCI_GRP C_YEAR_GRP1 LTC_MAIN_USE SURVTIME&YR. DEATH&YR) ; SET DB.TG_DEMO; &COND.; RUN;
PROC PHREG DATA=TG_DEMO_MUL;
CLASS SEX_TYPE (REF='2') C_AGE_GRP2 (REF='01. 65-74') INC_QUINTILE(REF='5') SIDO_CD(REF='11') CCI_GRP(REF='01. 0-2') 
C_YEAR_GRP1(REF="01. 2009-2011") LTC_MAIN_USE (REF='04. 이용안함') ;
MODEL SURVTIME&YR.*DEATH&YR.(0)=SEX_TYPE C_AGE_GRP2 INC_QUINTILE SIDO_CD CCI_GRP C_YEAR_GRP1 LTC_MAIN_USE 
/RL; RUN;




/*Table 4d. Cox model for surgery group (n=)*/
%LET COND= WHERE OP_YN=1;
/*단변량*/
%PHREG_UNI(SEX_TYPE,'2');
%PHREG_UNI(C_AGE_GRP2,'01. 65-74');
%PHREG_UNI(INC_QUINTILE,'5');
%PHREG_UNI(SIDO_CD,'11');
%PHREG_UNI(RESID_GRP,'01.METRO');
%PHREG_UNI(CCI_GRP,'01. 0-2');
%PHREG_UNI(C_YEAR_GRP1,'01. 2009-2011');
%PHREG_UNI(LTC_MAIN_USE,'04. 이용안함');
/*%PHREG_UNI(TRT_YN,'0');*/
/*%PHREG_UNI(OP_YN,'0');*/
%PHREG_UNI(CT_YN,'0');
%PHREG_UNI(RT_YN,'0');
%PHREG_UNI(OP_CTG,'04. Wedge');
%PHREG_UNI(CT_CYT_YN,'0');
%PHREG_UNI(CT_TAR_YN,'0');
%PHREG_UNI(CT_IMU_YN,'0');
%PHREG_UNI(CT_OTH_YN,'0');


/*다변량 : 모형 2*/
DATA TG_DEMO_MUL2 (KEEP=SEX_TYPE C_AGE_GRP2 INC_QUINTILE SIDO_CD CCI_GRP C_YEAR_GRP1 LTC_MAIN_USE OP_CTG CT_CYT_YN CT_TAR_YN CT_IMU_YN CT_OTH_YN RT_YN SURVTIME&YR. DEATH&YR.) ; SET DB.TG_DEMO; &COND.; RUN;
PROC PHREG DATA=TG_DEMO_MUL2;
CLASS SEX_TYPE (REF='2') C_AGE_GRP2 (REF='01. 65-74') INC_QUINTILE(REF='5') SIDO_CD(REF='11') CCI_GRP(REF='01. 0-2') 
C_YEAR_GRP1(REF="01. 2009-2011") LTC_MAIN_USE (REF='04. 이용안함') OP_CTG(REF='04. Wedge') CT_CYT_YN(REF='0') CT_TAR_YN(REF='0') CT_IMU_YN(REF='0') CT_OTH_YN(REF='0')  RT_YN(REF='0') ;
MODEL SURVTIME&YR.*DEATH&YR.(0)=SEX_TYPE C_AGE_GRP2 INC_QUINTILE SIDO_CD CCI_GRP C_YEAR_GRP1 LTC_MAIN_USE OP_CTG CT_CYT_YN CT_TAR_YN CT_IMU_YN CT_OTH_YN RT_YN
/RL; RUN;

/*다변량 : 모형 3*/
DATA TG_DEMO_MUL3 (KEEP=SEX_TYPE C_AGE_GRP2 INC_QUINTILE SIDO_CD CCI_GRP C_YEAR_GRP1 LTC_MAIN_USE OP_CTG CT_YN RT_YN SURVTIME&YR. DEATH&YR.) ; SET DB.TG_DEMO; &COND.; RUN;
PROC PHREG DATA=TG_DEMO_MUL3;
CLASS SEX_TYPE (REF='2') C_AGE_GRP2 (REF='01. 65-74') INC_QUINTILE(REF='5') SIDO_CD(REF='11') CCI_GRP(REF='01. 0-2') 
C_YEAR_GRP1(REF="01. 2009-2011") LTC_MAIN_USE (REF='04. 이용안함')  OP_CTG(REF='04. Wedge')  CT_YN(REF='0') RT_YN(REF='0') ;
MODEL SURVTIME&YR.*DEATH&YR.(0)=SEX_TYPE C_AGE_GRP2 INC_QUINTILE SIDO_CD CCI_GRP C_YEAR_GRP1 LTC_MAIN_USE  OP_CTG CT_YN RT_YN
/RL;  RUN;




/*Table 3. KM survival estimates*/
%MACRO KMEST(COND, CONDNAME);
PROC LIFETEST DATA=DB.TG_DEMO TIMELIST=365 730 1095 1460 1825 NOTABLE REDUCEOUT PLOTS=SURVIVAL OUTSURV=TMP;
TIME SURVTIME*DEATH(0); &COND. ; RUN;

DATA ESTCI_1YR (DROP=TIMELIST SURVTIME _CENSOR_ ); SET TMP; 
LTC_MAIN_USE='00. 전체 환자';  RENAME SURVIVAL=SURV_1YR  SDF_LCL=LCI_1YR  SDF_UCL=UCI_1YR  ; WHERE TIMELIST=365; RUN;
DATA ESTCI_3YR(DROP=TIMELIST SURVTIME _CENSOR_ ); SET TMP; 
LTC_MAIN_USE='00. 전체 환자';  RENAME SURVIVAL=SURV_3YR SDF_LCL=LCI_3YR SDF_UCL=UCI_3YR ; WHERE TIMELIST=1095; RUN;
DATA ESTCI_5YR(DROP=TIMELIST SURVTIME _CENSOR_ ); SET TMP; 
LTC_MAIN_USE='00. 전체 환자';  RENAME SURVIVAL=SURV_5YR SDF_LCL=LCI_5YR SDF_UCL=UCI_5YR ; WHERE TIMELIST=1825; RUN;

DATA KM_ALL;  RETAIN  LTC_MAIN_USE SURV_1YR LCI_1YR UCI_1YR SURV_3YR LCI_3YR UCI_3YR SURV_5YR LCI_5YR UCI_5YR; MERGE ESTCI_1YR ESTCI_3YR ESTCI_5YR; BY LTC_MAIN_USE;  RUN;

PROC LIFETEST DATA=DB.TG_DEMO TIMELIST=365 730 1095 1460 1825 NOTABLE REDUCEOUT PLOTS=SURVIVAL OUTSURV=TMP;
TIME SURVTIME*DEATH(0); STRATA LTC_MAIN_USE; ODS OUTPUT HOMTESTS=LRT_&CONDNAME. ; &COND. ; RUN;

DATA ESTCI_1YR (DROP=TIMELIST SURVTIME _CENSOR_ STRATUM); SET TMP; 
RENAME SURVIVAL=SURV_1YR  SDF_LCL=LCI_1YR  SDF_UCL=UCI_1YR  ; WHERE TIMELIST=365; RUN;
DATA ESTCI_3YR(DROP=TIMELIST SURVTIME _CENSOR_ STRATUM); SET TMP; 
RENAME SURVIVAL=SURV_3YR SDF_LCL=LCI_3YR SDF_UCL=UCI_3YR ; WHERE TIMELIST=1095; RUN;
DATA ESTCI_5YR(DROP=TIMELIST SURVTIME _CENSOR_ STRATUM); SET TMP; 
RENAME SURVIVAL=SURV_5YR SDF_LCL=LCI_5YR SDF_UCL=UCI_5YR ; WHERE TIMELIST=1825; RUN;

DATA KM_LTC; MERGE ESTCI_1YR ESTCI_3YR ESTCI_5YR; BY LTC_MAIN_USE; RUN;

DATA KM_&CONDNAME. ; SET  KM_ALL KM_LTC; RUN;
%MEND;


/*ALL PATIENTS*/
%KMEST(COND= , CONDNAME=65U);
%KMEST(COND= WHERE C_AGE_GRP2='01. 65-74', CONDNAME=6574);
%KMEST(COND= WHERE C_AGE_GRP2='02. 75-84', CONDNAME=7584);
%KMEST(COND= WHERE C_AGE_GRP2='03. 85+', CONDNAME=85U);

%KMEST(COND= WHERE SEX_TYPE='1', CONDNAME=M65U);
%KMEST(COND= WHERE SEX_TYPE='1' AND C_AGE_GRP2='01. 65-74', CONDNAME=M6574);
%KMEST(COND= WHERE SEX_TYPE='1' AND C_AGE_GRP2='02. 75-84', CONDNAME=M7584);
%KMEST(COND= WHERE SEX_TYPE='1' AND C_AGE_GRP2='03. 85+', CONDNAME=M85U);

%KMEST(COND= WHERE SEX_TYPE='2' , CONDNAME=F65U);
%KMEST(COND= WHERE SEX_TYPE='2' AND C_AGE_GRP2='01. 65-74', CONDNAME=F6574);
%KMEST(COND= WHERE SEX_TYPE='2' AND C_AGE_GRP2='02. 75-84', CONDNAME=F7584);
%KMEST(COND= WHERE SEX_TYPE='2' AND C_AGE_GRP2='03. 85+', CONDNAME=F85U);

DATA RES.KMEST_TOT; SET KM_65U KM_6574 KM_7584 KM_85U KM_M65U KM_M6574 KM_M7584 KM_M85U KM_F65U KM_F6574 KM_F7584 KM_F85U; RUN;
DATA RES.LRT_TOT; SET LRT_65U LRT_6574 LRT_7584 LRT_85U LRT_M65U LRT_M6574 LRT_M7584 LRT_M85U LRT_F65U LRT_F6574 LRT_F7584 LRT_F85U; RUN;


/*TREATMENT GROUP*/
%KMEST(COND= WHERE TRT_YN=1, CONDNAME=TRT_65U);
%KMEST(COND= WHERE TRT_YN=1 AND C_AGE_GRP2='01. 65-74', CONDNAME=TRT_6574);
%KMEST(COND= WHERE TRT_YN=1 AND C_AGE_GRP2='02. 75-84', CONDNAME=TRT_7584);
%KMEST(COND= WHERE TRT_YN=1 AND C_AGE_GRP2='03. 85+', CONDNAME=TRT_85U);

%KMEST(COND= WHERE TRT_YN=1 AND SEX_TYPE='1', CONDNAME=TRT_M65U);
%KMEST(COND= WHERE TRT_YN=1 AND SEX_TYPE='1' AND C_AGE_GRP2='01. 65-74', CONDNAME=TRT_M6574);
%KMEST(COND= WHERE TRT_YN=1 AND SEX_TYPE='1' AND C_AGE_GRP2='02. 75-84', CONDNAME=TRT_M7584);
%KMEST(COND= WHERE TRT_YN=1 AND SEX_TYPE='1' AND C_AGE_GRP2='03. 85+', CONDNAME=TRT_M85U);

%KMEST(COND= WHERE TRT_YN=1 AND SEX_TYPE='2', CONDNAME=TRT_F65U);
%KMEST(COND= WHERE TRT_YN=1 AND SEX_TYPE='2' AND C_AGE_GRP2='01. 65-74', CONDNAME=TRT_F6574);
%KMEST(COND= WHERE TRT_YN=1 AND SEX_TYPE='2' AND C_AGE_GRP2='02. 75-84', CONDNAME=TRT_F7584);
%KMEST(COND= WHERE TRT_YN=1 AND SEX_TYPE='2' AND C_AGE_GRP2='03. 85+', CONDNAME=TRT_F85U);

DATA RES.KMEST_TRT; SET KM_TRT_65U KM_TRT_6574 KM_TRT_7584 KM_TRT_85U KM_TRT_M65U KM_TRT_M6574 KM_TRT_M7584 KM_TRT_M85U KM_TRT_F65U KM_TRT_F6574 KM_TRT_F7584 KM_TRT_F85U; RUN;
DATA RES.LRT_TRT; SET LRT_TRT_65U LRT_TRT_6574 LRT_TRT_7584 LRT_TRT_85U LRT_TRT_M65U LRT_TRT_M6574 LRT_TRT_M7584 LRT_TRT_M85U LRT_TRT_F65U LRT_TRT_F6574 LRT_TRT_F7584 LRT_TRT_F85U; RUN;


/*SURGERY PATIENTS*/
%KMEST(COND= WHERE OP_YN=1 , CONDNAME=OP_65U);
%KMEST(COND= WHERE OP_YN=1 AND C_AGE_GRP2='01. 65-74', CONDNAME=OP_6574);
%KMEST(COND= WHERE OP_YN=1 AND C_AGE_GRP2='02. 75-84', CONDNAME=OP_7584);
%KMEST(COND= WHERE OP_YN=1 AND C_AGE_GRP2='03. 85+', CONDNAME=OP_85U);

%KMEST(COND= WHERE OP_YN=1 AND SEX_TYPE='1', CONDNAME=OP_M65U);
%KMEST(COND= WHERE OP_YN=1 AND SEX_TYPE='1' AND C_AGE_GRP2='01. 65-74', CONDNAME=OP_M6574);
%KMEST(COND= WHERE OP_YN=1 AND SEX_TYPE='1' AND C_AGE_GRP2='02. 75-84', CONDNAME=OP_M7584);
%KMEST(COND= WHERE OP_YN=1 AND SEX_TYPE='1' AND C_AGE_GRP2='03. 85+', CONDNAME=OP_M85U);

%KMEST(COND= WHERE OP_YN=1 AND SEX_TYPE='2', CONDNAME=OP_F65U);
%KMEST(COND= WHERE OP_YN=1 AND SEX_TYPE='2' AND C_AGE_GRP2='01. 65-74', CONDNAME=OP_F6574);
%KMEST(COND= WHERE OP_YN=1 AND SEX_TYPE='2' AND C_AGE_GRP2='02. 75-84', CONDNAME=OP_F7584);
%KMEST(COND= WHERE OP_YN=1 AND SEX_TYPE='2' AND C_AGE_GRP2='03. 85+', CONDNAME=OP_F85U);

DATA RES.KMEST_OP; SET KM_OP_65U KM_OP_6574 KM_OP_7584 KM_OP_85U KM_OP_M65U KM_OP_M6574 KM_OP_M7584 KM_OP_M85U KM_OP_F65U KM_OP_F6574 KM_OP_F7584 KM_OP_F85U; RUN;
DATA RES.LRT_OP; SET LRT_OP_65U LRT_OP_6574 LRT_OP_7584 LRT_OP_85U LRT_OP_M65U LRT_OP_M6574 LRT_OP_M7584 LRT_OP_M85U LRT_OP_F65U LRT_OP_F6574 LRT_OP_F7584 LRT_OP_F85U; RUN;



/*NO TREATMENT GROUP*/
%KMEST(COND= WHERE TRT_YN=0, CONDNAME=NOTRT_65U);
%KMEST(COND= WHERE TRT_YN=0 AND C_AGE_GRP2='01. 65-74', CONDNAME=NOTRT_6574);
%KMEST(COND= WHERE TRT_YN=0 AND C_AGE_GRP2='02. 75-84', CONDNAME=NOTRT_7584);
%KMEST(COND= WHERE TRT_YN=0 AND C_AGE_GRP2='03. 85+', CONDNAME=NOTRT_85U);

%KMEST(COND= WHERE TRT_YN=0 AND SEX_TYPE='1', CONDNAME=NOTRT_M65U);
%KMEST(COND= WHERE TRT_YN=0 AND SEX_TYPE='1' AND C_AGE_GRP2='01. 65-74', CONDNAME=NOTRT_M6574);
%KMEST(COND= WHERE TRT_YN=0 AND SEX_TYPE='1' AND C_AGE_GRP2='02. 75-84', CONDNAME=NOTRT_M7584);
%KMEST(COND= WHERE TRT_YN=0 AND SEX_TYPE='1' AND C_AGE_GRP2='03. 85+', CONDNAME=NOTRT_M85U);

%KMEST(COND= WHERE TRT_YN=0 AND SEX_TYPE='2', CONDNAME=NOTRT_F65U);
%KMEST(COND= WHERE TRT_YN=0 AND SEX_TYPE='2' AND C_AGE_GRP2='01. 65-74', CONDNAME=NOTRT_F6574);
%KMEST(COND= WHERE TRT_YN=0 AND SEX_TYPE='2' AND C_AGE_GRP2='02. 75-84', CONDNAME=NOTRT_F7584);
%KMEST(COND= WHERE TRT_YN=0 AND SEX_TYPE='2' AND C_AGE_GRP2='03. 85+', CONDNAME=NOTRT_F85U);

DATA RES.KMEST_NOTRT; SET KM_NOTRT_65U KM_NOTRT_6574 KM_NOTRT_7584 KM_NOTRT_85U KM_NOTRT_M65U KM_NOTRT_M6574 KM_NOTRT_M7584 KM_NOTRT_M85U KM_NOTRT_F65U KM_NOTRT_F6574 KM_NOTRT_F7584 KM_NOTRT_F85U; RUN;
DATA RES.LRT_NOTRT; SET LRT_NOTRT_65U LRT_NOTRT_6574 LRT_NOTRT_7584 LRT_NOTRT_85U LRT_NOTRT_M65U LRT_NOTRT_M6574 LRT_NOTRT_M7584 LRT_NOTRT_M85U LRT_NOTRT_F65U LRT_NOTRT_F6574 LRT_NOTRT_F7584 LRT_NOTRT_F85U; RUN;



/*1, 3, 5YEAR LOG-RANK TEST*/
%MACRO LRT(COND, CONDNAME);
PROC LIFETEST DATA=DB.TG_DEMO TIMELIST=365 730 1095 1460 1825 NOTABLE REDUCEOUT PLOTS=SURVIVAL OUTSURV=TMP;
TIME SURVTIME_1YR*DEATH_1YR(0); STRATA LTC_MAIN_USE; ODS OUTPUT HOMTESTS=LRT1; &COND. ; RUN;
PROC LIFETEST DATA=DB.TG_DEMO TIMELIST=365 730 1095 1460 1825 NOTABLE REDUCEOUT PLOTS=SURVIVAL OUTSURV=TMP;
TIME SURVTIME_3YR*DEATH_3YR(0); STRATA LTC_MAIN_USE; ODS OUTPUT HOMTESTS=LRT3; &COND. ; RUN;
PROC LIFETEST DATA=DB.TG_DEMO TIMELIST=365 730 1095 1460 1825 NOTABLE REDUCEOUT PLOTS=SURVIVAL OUTSURV=TMP;
TIME SURVTIME_5YR*DEATH_5YR(0); STRATA LTC_MAIN_USE; ODS OUTPUT HOMTESTS=LRT5; &COND. ; RUN;

DATA LRT_1YR; SET LRT1 ;  RENAME CHISQ=CHISQ_1YR DF=DF_1YR PROBCHISQ=PVAL_1YR ; RUN;
DATA LRT_3YR; SET LRT3 ;  RENAME CHISQ=CHISQ_3YR DF=DF_3YR PROBCHISQ=PVAL_3YR ; RUN;
DATA LRT_5YR; SET LRT5 ;  RENAME CHISQ=CHISQ_5YR DF=DF_5YR PROBCHISQ=PVAL_5YR ; RUN;
PROC SQL; CREATE TABLE LRT135_&CONDNAME. AS SELECT A.*,B.*,C.* FROM LRT_1YR AS A LEFT JOIN LRT_3YR AS B ON A.TEST=B.TEST LEFT JOIN LRT_5YR AS C ON A.TEST=C.TEST; QUIT;
%MEND;


/*ALL PATIENTS*/
%LRT(COND= , CONDNAME=65U);
%LRT(COND= WHERE C_AGE_GRP2='01. 65-74', CONDNAME=6574);
%LRT(COND= WHERE C_AGE_GRP2='02. 75-84', CONDNAME=7584);
%LRT(COND= WHERE C_AGE_GRP2='03. 85+', CONDNAME=85U);

%LRT(COND= WHERE SEX_TYPE='1', CONDNAME=M65U);
%LRT(COND= WHERE SEX_TYPE='1' AND C_AGE_GRP2='01. 65-74', CONDNAME=M6574);
%LRT(COND= WHERE SEX_TYPE='1' AND C_AGE_GRP2='02. 75-84', CONDNAME=M7584);
%LRT(COND= WHERE SEX_TYPE='1' AND C_AGE_GRP2='03. 85+', CONDNAME=M85U);

%LRT(COND= WHERE SEX_TYPE='2' , CONDNAME=F65U);
%LRT(COND= WHERE SEX_TYPE='2' AND C_AGE_GRP2='01. 65-74', CONDNAME=F6574);
%LRT(COND= WHERE SEX_TYPE='2' AND C_AGE_GRP2='02. 75-84', CONDNAME=F7584);
%LRT(COND= WHERE SEX_TYPE='2' AND C_AGE_GRP2='03. 85+', CONDNAME=F85U);

DATA RES.LRT135_TOT; SET LRT135_65U LRT135_6574 LRT135_7584 LRT135_85U LRT135_M65U LRT135_M6574 LRT135_M7584 LRT135_M85U LRT135_F65U LRT135_F6574 LRT135_F7584 LRT135_F85U; RUN;


/*TREATMENT GROUP*/
%LRT(COND= WHERE TRT_YN=1, CONDNAME=TRT_65U);
%LRT(COND= WHERE TRT_YN=1 AND C_AGE_GRP2='01. 65-74', CONDNAME=TRT_6574);
%LRT(COND= WHERE TRT_YN=1 AND C_AGE_GRP2='02. 75-84', CONDNAME=TRT_7584);
%LRT(COND= WHERE TRT_YN=1 AND C_AGE_GRP2='03. 85+', CONDNAME=TRT_85U);

%LRT(COND= WHERE TRT_YN=1 AND SEX_TYPE='1', CONDNAME=TRT_M65U);
%LRT(COND= WHERE TRT_YN=1 AND SEX_TYPE='1' AND C_AGE_GRP2='01. 65-74', CONDNAME=TRT_M6574);
%LRT(COND= WHERE TRT_YN=1 AND SEX_TYPE='1' AND C_AGE_GRP2='02. 75-84', CONDNAME=TRT_M7584);
%LRT(COND= WHERE TRT_YN=1 AND SEX_TYPE='1' AND C_AGE_GRP2='03. 85+', CONDNAME=TRT_M85U);

%LRT(COND= WHERE TRT_YN=1 AND SEX_TYPE='2', CONDNAME=TRT_F65U);
%LRT(COND= WHERE TRT_YN=1 AND SEX_TYPE='2' AND C_AGE_GRP2='01. 65-74', CONDNAME=TRT_F6574);
%LRT(COND= WHERE TRT_YN=1 AND SEX_TYPE='2' AND C_AGE_GRP2='02. 75-84', CONDNAME=TRT_F7584);
%LRT(COND= WHERE TRT_YN=1 AND SEX_TYPE='2' AND C_AGE_GRP2='03. 85+', CONDNAME=TRT_F85U);

DATA RES.LRT135_TRT; SET LRT135_TRT_65U LRT135_TRT_6574 LRT135_TRT_7584 LRT135_TRT_85U LRT135_TRT_M65U LRT135_TRT_M6574 LRT135_TRT_M7584 LRT135_TRT_M85U LRT135_TRT_F65U LRT135_TRT_F6574 LRT135_TRT_F7584 LRT135_TRT_F85U; RUN;


/*SURGERY PATIENTS*/
%LRT(COND= WHERE OP_YN=1 , CONDNAME=OP_65U);
%LRT(COND= WHERE OP_YN=1 AND C_AGE_GRP2='01. 65-74', CONDNAME=OP_6574);
%LRT(COND= WHERE OP_YN=1 AND C_AGE_GRP2='02. 75-84', CONDNAME=OP_7584);
%LRT(COND= WHERE OP_YN=1 AND C_AGE_GRP2='03. 85+', CONDNAME=OP_85U);

%LRT(COND= WHERE OP_YN=1 AND SEX_TYPE='1', CONDNAME=OP_M65U);
%LRT(COND= WHERE OP_YN=1 AND SEX_TYPE='1' AND C_AGE_GRP2='01. 65-74', CONDNAME=OP_M6574);
%LRT(COND= WHERE OP_YN=1 AND SEX_TYPE='1' AND C_AGE_GRP2='02. 75-84', CONDNAME=OP_M7584);
%LRT(COND= WHERE OP_YN=1 AND SEX_TYPE='1' AND C_AGE_GRP2='03. 85+', CONDNAME=OP_M85U);

%LRT(COND= WHERE OP_YN=1 AND SEX_TYPE='2', CONDNAME=OP_F65U);
%LRT(COND= WHERE OP_YN=1 AND SEX_TYPE='2' AND C_AGE_GRP2='01. 65-74', CONDNAME=OP_F6574);
%LRT(COND= WHERE OP_YN=1 AND SEX_TYPE='2' AND C_AGE_GRP2='02. 75-84', CONDNAME=OP_F7584);
%LRT(COND= WHERE OP_YN=1 AND SEX_TYPE='2' AND C_AGE_GRP2='03. 85+', CONDNAME=OP_F85U);

DATA RES.LRT135_OP; SET LRT135_OP_65U LRT135_OP_6574 LRT135_OP_7584 LRT135_OP_85U LRT135_OP_M65U LRT135_OP_M6574 LRT135_OP_M7584 LRT135_OP_M85U LRT135_OP_F65U LRT135_OP_F6574 LRT135_OP_F7584 LRT135_OP_F85U; RUN;



/*NO TREATMENT GROUP*/
%LRT(COND= WHERE TRT_YN=0, CONDNAME=NOTRT_65U);
%LRT(COND= WHERE TRT_YN=0 AND C_AGE_GRP2='01. 65-74', CONDNAME=NOTRT_6574);
%LRT(COND= WHERE TRT_YN=0 AND C_AGE_GRP2='02. 75-84', CONDNAME=NOTRT_7584);
%LRT(COND= WHERE TRT_YN=0 AND C_AGE_GRP2='03. 85+', CONDNAME=NOTRT_85U);

%LRT(COND= WHERE TRT_YN=0 AND SEX_TYPE='1', CONDNAME=NOTRT_M65U);
%LRT(COND= WHERE TRT_YN=0 AND SEX_TYPE='1' AND C_AGE_GRP2='01. 65-74', CONDNAME=NOTRT_M6574);
%LRT(COND= WHERE TRT_YN=0 AND SEX_TYPE='1' AND C_AGE_GRP2='02. 75-84', CONDNAME=NOTRT_M7584);
%LRT(COND= WHERE TRT_YN=0 AND SEX_TYPE='1' AND C_AGE_GRP2='03. 85+', CONDNAME=NOTRT_M85U);

%LRT(COND= WHERE TRT_YN=0 AND SEX_TYPE='2', CONDNAME=NOTRT_F65U);
%LRT(COND= WHERE TRT_YN=0 AND SEX_TYPE='2' AND C_AGE_GRP2='01. 65-74', CONDNAME=NOTRT_F6574);
%LRT(COND= WHERE TRT_YN=0 AND SEX_TYPE='2' AND C_AGE_GRP2='02. 75-84', CONDNAME=NOTRT_F7584);
%LRT(COND= WHERE TRT_YN=0 AND SEX_TYPE='2' AND C_AGE_GRP2='03. 85+', CONDNAME=NOTRT_F85U);

DATA RES.LRT135_NOTRT; SET LRT135_NOTRT_65U LRT135_NOTRT_6574 LRT135_NOTRT_7584 LRT135_NOTRT_85U LRT135_NOTRT_M65U LRT135_NOTRT_M6574 LRT135_NOTRT_M7584 LRT135_NOTRT_M85U LRT135_NOTRT_F65U LRT135_NOTRT_F6574 LRT135_NOTRT_F7584 LRT135_NOTRT_F85U; RUN;
